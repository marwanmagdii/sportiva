<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sportiva - Marketplace</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: #f8fafc; /* Tailwind gray-50 */
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        
        /* General Styles */
        .page-active { background-color: #059669; color: white; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        .enhanced-shadow { box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .enhanced-shadow:hover { box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.1), 0 6px 12px -6px rgba(0, 0, 0, 0.08); transform: translateY(-2px); }
        .nav-link-animated { position: relative; transition: all 0.3s ease; padding-bottom: 4px; }
        .nav-link-animated::after { content: ''; position: absolute; width: 0; height: 2px; bottom: 0; left: 50%; background-color: #10b981; transition: all 0.3s ease; transform: translateX(-50%); }
        .nav-link-animated:hover { color: #059669; transform: translateY(-2px); }
        .nav-link-animated:hover::after { width: 100%; }

        /* Filter Styles */
        .dropdown-checkbox-list { max-height: 200px; overflow-y: auto; scrollbar-width: none; }
        .dropdown-checkbox-list::-webkit-scrollbar { display: none; }
        .color-circle { width: 1rem; height: 1rem; border-radius: 9999px; border: 1px solid #d1d5db; margin-right: 0.5rem; flex-shrink: 0; }
        input[type="checkbox"] { -webkit-appearance: none; appearance: none; display: inline-block; height: 1rem; width: 1rem; background-color: #fff; border: 1px solid #d1d5db; border-radius: 0.25rem; position: relative; cursor: pointer; flex-shrink: 0; margin-right: 0.5rem; transition: all 0.2s; }
        input[type="checkbox"]:checked { background-color: #059669; border-color: #059669; }
        input[type="checkbox"]:checked::after { content: ''; position: absolute; top: 2px; left: 2px; width: 8px; height: 8px; border-bottom: 2px solid #fff; border-right: 2px solid #fff; transform: rotate(45deg); }
        .filter-item-label { display: flex; align-items: center; padding: 0.5rem; cursor: pointer; border-radius: 0.375rem; transition: background-color 0.15s; }
        .filter-item-label:hover { background-color: #f3f4f6; }

        /* Product Detail Page Styles */
        .color-swatch {
            width: 2.5rem; height: 2.5rem; border-radius: 9999px; cursor: pointer;
            border: 2px solid #e5e7eb; transition: all 0.2s ease-in-out;
        }
        .color-swatch:hover { border-color: #9ca3af; }
        .color-swatch.selected { border-color: #059669; box-shadow: 0 0 0 2px #a7f3d0; }
        
        .size-button {
            min-width: 3rem; padding: 0.5rem 0.75rem; border-radius: 8px; cursor: pointer;
            border: 2px solid #e5e7eb; background-color: white; color: #374151;
            font-weight: 600; text-align: center; transition: all 0.2s ease-in-out;
        }
        .size-button:hover { border-color: #9ca3af; }
        .size-button.selected { border-color: #059669; background-color: #ecfdf5; color: #065f46; }

        /* Star rating styles for review form */
        .star-rating-input .fa-star { color: #d1d5db; cursor: pointer; transition: color 0.2s; }
        .star-rating-input .fa-star.hover,
        .star-rating-input .fa-star.filled { color: #f59e0b; }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">
    <!-- Main application container -->
    <div id="app" class="flex-grow"></div>

    <script>
        // --- MOCK DATA ---
        const mockData = { user: { name: "Karim Ahmed", email: "karim.ahmed@example.com", profileImage: "images/people/people 1.png" } };
        const mockProducts = [
            { id: 'prod1', productImages: [{ color: '#FF0000', imageUrl: 'images/marketplace/red shoes.png' }, { color: '#0000FF', imageUrl: 'images/marketplace/blue shoes.png' }, { color: '#008000', imageUrl: 'images/marketplace/green shoes.png' }], imageAlt: 'Football Cleats', provider: 'Adidas', title: 'Predator Accuracy Football Shoes', description: 'Lightweight and durable cleats for optimal performance on the field. Features a synthetic upper for a snug fit. A firm ground outsole provides exceptional traction.', rating: 4.8, reviews: 85, offerStatus: 'Limited stock available!', price: 89.99, category: 'Shoes', sizes: ['39', '40', '41', '42', '43', '44'], customerReviews: [{ name: 'Ali', rating: 5, comment: 'Excellent grip and very comfortable. Best shoes I have owned.' }, { name: 'Sara', rating: 4, comment: 'Good value for money, but took a while to break in.' }] },
            { id: 'prod2', productImages: [{ color: '#000000', imageUrl: 'images/marketplace/Goalkeeper Gloves black.png' }, { color: '#A9A9A9', imageUrl: 'images/marketplace/Goalkeeper Gloves grey.png' }], imageAlt: 'Goalkeeper Gloves', provider: 'Nike', title: 'Phantom Grip Goalkeeper Gloves', description: 'Superior grip and comfort for crucial saves. All-weather performance. Cushioned foam for shot absorption.', rating: 4.5, reviews: 120, offerStatus: 'In stock', price: 59.99, category: 'Gloves', sizes: ['8', '9', '10', '11'], customerReviews: [{ name: 'Omar', rating: 5, comment: 'The grip is fantastic, even in wet conditions.' }, { name: 'Fatma', rating: 5, comment: 'Very durable. I have used them for a full season and they are still great.' }] },
            { id: 'prod3', productImages: [{ color: '#FFFFFF', imageUrl: 'images/marketplace/Manchester City T-shirt white.png' }, { color: '#000080', imageUrl: 'images/marketplace/Manchester City T-shirt navy.png' }], imageAlt: 'Football Jersey', provider: 'Puma', title: 'Manchester City T-shirt', description: 'Breathable fabric, perfect for training or match day. Customizable options available.', rating: 4.2, reviews: 60, offerStatus: 'New arrival!', price: 34.99, category: 'T-shirt', sizes: ['S', 'M', 'L', 'XL', 'XXL'], customerReviews: [] },
            { id: 'prod4', productImages: [{ color: '#FFD700', imageUrl: 'images/marketplace/football yellow.png' }, { color: '#C0C0C0', imageUrl: 'images/marketplace/football grey.png' }], imageAlt: 'Official Match Ball', provider: 'Sportiva', title: 'Official Match Football', description: 'FIFA approved for professional play. Durable outer shell for consistent trajectory. Thermally bonded seamless surface.', rating: 4.9, reviews: 200, offerStatus: 'Best Seller', price: 120.00, category: 'Ball', sizes: ['5'], customerReviews: [{ name: 'Youssef', rating: 5, comment: 'Flies true and has a great feel. Worth the price.' }] },
            { id: 'prod5', productImages: [{ color: '#FF4500', imageUrl: 'images/marketplace/Shin Pads red.png' }, { color: '#8A2BE2', imageUrl: 'images/marketplace/Shin Pads purple.png' }], imageAlt: 'Football Shin Pads', provider: 'Nike', title: 'Charge Shin Pads', description: 'Lightweight and durable for maximum protection. Ergonomic fit for comfort. Hard shell with foam backing for cushioning.', rating: 4.7, reviews: 95, offerStatus: 'Limited stock available!', price: 25.50, category: 'Shin Pads', sizes: ['S', 'M', 'L'], customerReviews: [{ name: 'Hassan', rating: 5, comment: 'Saved my shins multiple times. Very light, I forget they are there.' }] },
            { id: 'prod6', productImages: [{ color: '#000080', imageUrl: 'images/marketplace/Training Tracksuit navy.png' }, { color: '#36454F', imageUrl: 'images/marketplace/Training Tracksuit charcoal.png' }], imageAlt: 'Football Tracksuit', provider: 'Adidas', title: 'Tiro 23 Training Tracksuit', description: 'Moisture-wicking material to keep you dry. Comfortable during intense training sessions. Made with recycled materials.', rating: 4.6, reviews: 110, offerStatus: 'In stock', price: 75.00, category: 'Tracksuit', sizes: ['S', 'M', 'L', 'XL'], customerReviews: [] },
            { id: 'prod7', productImages: [{ color: '#A52A2A', imageUrl: 'images/marketplace/Liverpool T-shirt red.png' }, { color: '#808000', imageUrl: 'images/marketplace/Liverpool T-shirt olive.png' }], imageAlt: 'Casual T-shirt', provider: 'Liverpool FC', title: 'Liverpool FC T-shirt', description: 'Support your team with this official Liverpool FC merchandise. 100% soft cotton for all-day comfort.', rating: 4.3, reviews: 50, offerStatus: 'New arrival!', price: 19.99, category: 'T-shirt', sizes: ['S', 'M', 'L', 'XL'], customerReviews: [] },
            { id: 'prod8', productImages: [{ color: '#87CEEB', imageUrl: 'images/marketplace/Water Bottle sky blue.png' }, { color: '#FFC0CB', imageUrl: 'images/marketplace/Water Bottle pink.png' }], imageAlt: 'Water Bottle', provider: 'HydratePro', title: 'Insulated Water Bottle', description: 'BPA-free and insulated to keep your drinks cold. Leak-proof design. Holds up to 750ml.', rating: 4.9, reviews: 150, offerStatus: 'Best Seller', price: 14.99, category: 'Bottle', customerReviews: [] },
            { id: 'prod9', productImages: [{ color: '#D3D3D3', imageUrl: 'images/marketplace/Sports Bag light grey.png' }, { color: '#800080', imageUrl: 'images/marketplace/Sports Bag light purple.png' }], imageAlt: 'Sports Bag', provider: 'VictoryGear', title: 'Endurance Sports Bag', description: 'Spacious and durable sports bag. Separate shoe compartment. Multiple pockets for organization.', rating: 4.6, reviews: 70, offerStatus: 'In stock', price: 49.99, category: 'Bag', customerReviews: [] }
        ];

        // --- GLOBAL STATE ---
        let appState = {
            view: 'grid', selectedProductId: null, currentPage: 1, productsPerPage: 6, modalContent: null, searchTerm: '',
            isProfileDropdownOpen: false, 
            isMobileMenuOpen: false, // State for mobile menu
            showAdvancedFilters: false, showCategoryDropdown: false, showColorDropdown: false, newReviewRating: 0,
            filters: { minPrice: '', maxPrice: '', minRating: '', selectedCategories: [], categorySearchTerm: '', selectedColors: [], colorSearchTerm: '' },
        };

        const colorMap = { '#ff0000': 'Red', '#0000ff': 'Blue', '#008000': 'Green', '#000000': 'Black', '#a9a9a9': 'Grey', '#ffffff': 'White', '#000080': 'Navy', '#ffd700': 'Yellow', '#c0c0c0': 'Silver', '#ff4500': 'Orange', '#8a2be2': 'Purple', '#36454f': 'Charcoal', '#a52a2a': 'Brown', '#808000': 'Olive', '#87ceeb': 'Sky Blue', '#ffc0cb': 'Pink', '#d3d3d3': 'Light Grey', '#800080': 'Light Purple', };
        const allCategories = [...new Set(mockProducts.map(p => p.category))].sort();
        const allColorNames = [...new Set(Object.values(colorMap))].sort();

        // --- NAVIGATION & STATE UPDATE ---
        function viewProductDetails(productId) { appState.view = 'detail'; appState.selectedProductId = productId; appState.newReviewRating = 0; window.scrollTo(0, 0); renderPage(); }
        function goBackToGrid() { appState.view = 'grid'; appState.selectedProductId = null; window.scrollTo(0, 0); renderPage(); }
        
        // --- HELPERS ---
        function renderModal(title, message) { return `<div class="fixed inset-0 bg-black bg-opacity-60 flex justify-center items-center z-50 p-4" onclick="closeModal()"><div class="bg-white rounded-lg enhanced-shadow max-w-md w-full relative p-8 text-center" onclick="event.stopPropagation()"><button onclick="closeModal()" class="absolute top-2 right-4 text-gray-500 hover:text-gray-800 text-3xl">×</button><h2 class="text-2xl font-bold mb-4">${title}</h2><p>${message}</p></div></div>`; }
        function closeModal() { appState.modalContent = null; renderPage(); }
        function renderStars(rating, isLarge = false) { const starSize = isLarge ? 'w-5 h-5' : 'w-4 h-4'; let starsHtml = ''; for (let i = 0; i < 5; i++) { if (i < Math.floor(rating)) { starsHtml += `<i class="fas fa-star ${starSize} text-yellow-400"></i>`; } else if (i < rating && (rating - i) > 0.25) { starsHtml += `<i class="fas fa-star-half-alt ${starSize} text-yellow-400"></i>`; } else { starsHtml += `<i class="far fa-star ${starSize} text-yellow-400"></i>`; } } return `<div class="flex items-center">${starsHtml}</div>`; }
        function rgbToHex(rgb) { let sep = rgb.indexOf(",") > -1 ? "," : " "; rgb = rgb.substr(4).split(")")[0].split(sep); let r = (+rgb[0]).toString(16), g = (+rgb[1]).toString(16), b = (+rgb[2]).toString(16); if (r.length == 1) r = "0" + r; if (g.length == 1) g = "0" + g; if (b.length == 1) b = "0" + b; return "#" + r + g + b; }
        
        // --- HEADER AND FOOTER ---
        function renderHeader() { 
            const mobileMenuIcon = appState.isMobileMenuOpen 
                ? `<i class="fas fa-times fa-lg"></i>` 
                : `<i class="fas fa-bars fa-lg"></i>`;

            return `
            <header class="bg-white shadow-lg sticky top-0 z-40">
                <nav class="container mx-auto px-4 sm:px-6 py-4 flex justify-between items-center">
                    <div class="flex-1 flex justify-start items-center">
                        <button id="mobile-menu-button" class="md:hidden text-gray-600 hover:text-emerald-600 focus:outline-none mr-4">
                            ${mobileMenuIcon}
                        </button>
                        <a href="index.html" class="flex items-center space-x-2">
                            <img src="images/logo/Sportiva logo.png" alt="Sportiva Logo" class="h-10 w-10" onerror="this.onerror=null;this.src='https://placehold.co/40x40/10b981/FFFFFF?text=S';">
                            <span class="text-3xl font-bold text-emerald-600">Sportiva</span>
                        </a>
                    </div>
                    
                    <div class="hidden md:flex flex-1 justify-center items-center space-x-12 text-xl">
                        <a href="fields.html" class="nav-link-animated text-gray-700 font-semibold">Fields</a>
                        <a href="find.html" class="nav-link-animated text-gray-700 font-semibold">Find</a>
                        <a href="marketplace.html" class="nav-link-animated text-gray-700 font-semibold">Marketplace</a>
                    </div>

                    <div class="flex-1 flex justify-end">
                        <div class="relative">
                            <button id="profile-button" class="block rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500">
                                <img src="${mockData.user.profileImage}" alt="Your profile picture" class="w-10 h-10 rounded-full object-cover border-2 border-emerald-500 hover:border-emerald-600 transition" onerror="this.onerror=null;this.src='https://placehold.co/40x40/E0E0E0/333333?text=KA';">
                            </button>
                            <div id="profile-dropdown" class="${appState.isProfileDropdownOpen ? '' : 'hidden'} absolute right-0 mt-2 w-56 bg-white rounded-md enhanced-shadow z-50 ring-1 ring-black ring-opacity-5">
                                <div class="px-4 py-3 border-b"><p class="text-sm font-semibold text-gray-800">${mockData.user.name}</p><p class="text-xs text-gray-500 truncate">${mockData.user.email}</p></div>
                                <div class="py-1 border-b"><p class="px-4 pt-2 pb-1 text-xs font-semibold text-gray-400 uppercase">Switch Dashboard</p><a href="player-dashboard.html" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"><i class="fas fa-user w-5 mr-2 text-gray-500"></i> Player</a><a href="coach-dashboard.html" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"><i class="fas fa-user-tie w-5 mr-2 text-gray-500"></i> Coach</a><a href="field-owner-dashboard.html" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"><i class="fas fa-map-marked-alt w-5 mr-2 text-gray-500"></i> Field Owner</a><a href="marketplace-dashboard.html" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"><i class="fas fa-store w-5 mr-2 text-gray-500"></i> Marketplace</a></div>
                                <div class="py-1"><a href="#" class="nav-link flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"><i class="fas fa-cog w-5 mr-2 text-gray-500"></i> Settings</a><a href="#" class="nav-link flex items-center px-4 py-2 text-sm text-red-600 hover:bg-gray-100"><i class="fas fa-sign-out-alt w-5 mr-2"></i> Sign Out</a></div>
                            </div>
                        </div>
                    </div>
                </nav>
                <!-- Mobile Menu -->
                <div id="mobile-menu" class="${appState.isMobileMenuOpen ? 'block' : 'hidden'} md:hidden bg-white border-t">
                    <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                        <a href="fields.html" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-emerald-600 hover:bg-gray-50">Fields</a>
                        <a href="find.html" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-emerald-600 hover:bg-gray-50">Find</a>
                        <a href="marketplace.html" class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:text-emerald-600 hover:bg-gray-50">Marketplace</a>
                    </div>
                </div>
            </header>`; 
        }

        function renderFooter() { return `<footer class="bg-gray-900 text-white"><div class="container mx-auto py-12 px-4 sm:px-6"><div class="grid grid-cols-1 md:grid-cols-4 gap-8 text-center md:text-left"><div class="md:col-span-1"><h2 class="text-3xl font-bold text-emerald-500">Sportiva</h2><p class="text-gray-400 mt-2">Your ultimate destination for sports.</p><div class="flex justify-center md:justify-start space-x-4 mt-4"><a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-facebook-f fa-lg"></i></a><a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-twitter fa-lg"></i></a><a href="#" class="text-gray-400 hover:text-white transition"><i class="fab fa-instagram fa-lg"></i></a></div></div><div><h3 class="font-semibold tracking-wider uppercase">Dashboards</h3><ul class="mt-4 space-y-2"><li><a href="player-dashboard.html" class="text-gray-400 hover:text-white">Player</a></li><li><a href="coach-dashboard.html" class="text-gray-400 hover:text-white">Coach</a></li><li><a href="field-owner-dashboard.html" class="text-gray-400 hover:text-white">Field Owner</a></li><li><a href="marketplace-dashboard.html" class="text-gray-400 hover:text-white">Marketplace</a></li></ul></div><div><h3 class="font-semibold tracking-wider uppercase">Find</h3><ul class="mt-4 space-y-2"><li><a href="find.html" class="text-gray-400 hover:text-white">Players</a></li><li><a href="find.html" class="text-gray-400 hover:text-white">Teams</a></li><li><a href="find.html" class="text-gray-400 hover:text-white">Coaches</a></li><li><a href="find.html" class="text-gray-400 hover:text-white">Challenges</a></li></ul></div><div><h3 class="font-semibold tracking-wider uppercase">More</h3><ul class="mt-4 space-y-2"><li><a href="fields.html" class="text-gray-400 hover:text-white">Fields</a></li><li><a href="marketplace.html" class="text-gray-400 hover:text-white">Marketplace</a></li><li><a href="about-us.html" class="text-gray-400 hover:text-white">About Us</a></li></ul></div></div><div class="border-t border-gray-700 mt-8 pt-6 text-center text-gray-500"><p>&copy; 2025 Sportiva. All Rights Reserved.</p></div></div></footer>`; }

        // --- GRID VIEW RENDER FUNCTIONS ---
        function renderProductCard(product) {
            const initialImage = product.productImages && product.productImages.length > 0 ? product.productImages[0].imageUrl : '';
            const initialColor = product.productImages && product.productImages.length > 0 ? product.productImages[0].color : '';

            const colorChoicesHtml = product.productImages.map((image, index) => `
                <div
                    data-product-id="${product.id}"
                    data-image-url="${image.imageUrl}"
                    data-color="${image.color}"
                    class="w-6 h-6 rounded-full border-2 cursor-pointer transition-transform duration-200 hover:scale-110
                        ${initialColor === image.color ? 'border-emerald-500 ring-2 ring-emerald-200' : 'border-gray-300'}
                        ${index < product.productImages.length - 1 ? 'mr-2' : ''}"
                    style="background-color: ${image.color};"
                    title="${colorMap[image.color.toLowerCase()] || 'Other'}"
                    onclick="handleGridColorClick(event, '${product.id}')"
                ></div>
            `).join('');

            return `
                <div id="product-card-${product.id}" class="bg-white rounded-xl enhanced-shadow overflow-hidden max-w-sm w-full flex flex-col transform transition-all duration-300 hover:scale-[1.02]">
                    <div class="relative h-48 sm:h-56 md:h-64 bg-gray-200 flex items-center justify-center overflow-hidden">
                        <img id="product-image-${product.id}" src="${initialImage}" alt="${product.imageAlt}" class="object-cover w-full h-full" onerror="this.onerror=null;this.src='https://placehold.co/600x400/E0E0E0/333333?text=Image+Not+Found';"/>
                    </div>
                    <div class="p-4 sm:p-6 flex flex-col flex-grow">
                        <p class="text-xs font-medium text-gray-500 mb-1">by ${product.provider}</p>
                        <h2 class="text-xl sm:text-2xl font-semibold text-gray-800 mb-2 leading-tight">${product.title}</h2>
                        <div class="flex items-center mb-3">
                            ${renderStars(product.rating)}
                            <span class="ml-2 text-sm text-gray-500">${product.reviews.toLocaleString()} reviews</span>
                        </div>
                        
                        ${product.productImages.length > 1 ? `
                        <div class="flex items-center mb-4">
                            <span class="text-gray-700 text-sm mr-2 font-medium">Colors:</span>
                            <div class="flex">
                                ${colorChoicesHtml}
                            </div>
                        </div>` : ''}

                        <p class="text-gray-700 text-sm mb-3 flex-grow"><span class="font-medium">${product.offerStatus}</span></p>
                        <div class="flex items-center justify-between mt-auto pt-4">
                            <div class="text-3xl font-bold text-gray-900">$${product.price.toFixed(2)}</div>
                        </div>
                        <button class="mt-4 w-full bg-white text-emerald-700 border-2 border-emerald-600 py-2.5 px-4 rounded-lg font-semibold text-lg hover:bg-emerald-50 focus:outline-none focus:ring-4 focus:ring-emerald-300 transition duration-200 ease-in-out" onclick="viewProductDetails('${product.id}')">
                            View Details
                        </button>
                    </div>
                </div>`;
        }
        function renderMarketplaceGrid() { const filteredProducts = getFilteredProducts(); const startIndex = (appState.currentPage - 1) * appState.productsPerPage; const endIndex = startIndex + appState.productsPerPage; const paginatedProducts = filteredProducts.slice(startIndex, endIndex); const productCardsHtml = paginatedProducts.map(product => renderProductCard(product)).join(''); return `<div class="bg-gray-50"><div class="container mx-auto px-6 py-12"><div class="text-center mb-12"><h1 class="text-4xl md:text-5xl font-extrabold text-gray-900">Explore Our Marketplace</h1><p class="text-lg text-gray-600 mt-2">Find the best gear for your game!</p></div><div class="grid lg:grid-cols-4 gap-8"><div class="hidden lg:block lg:col-span-1">${renderAdvancedFiltersSectionForMarketplace()}</div><div class="lg:col-span-3"><div class="flex flex-col md:flex-row gap-2 mb-4"><input type="text" id="search-term-marketplace" value="${appState.searchTerm}" placeholder="Search products..." class="p-3 border border-gray-300 rounded-lg w-full focus:ring-2 focus:ring-emerald-500 enhanced-shadow" /><button id="search-button-marketplace" class="bg-emerald-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-emerald-700 transition flex-shrink-0 flex items-center justify-center enhanced-shadow"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button></div><div class="lg:hidden col-span-4 mb-4"><button id="toggle-advanced-filters-marketplace" class="w-full bg-white p-4 rounded-lg enhanced-shadow flex justify-between items-center"><span class="font-semibold">Advanced Filters</span><svg class="w-5 h-5 transition-transform ${appState.showAdvancedFilters ? 'transform rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button>${appState.showAdvancedFilters ? `<div class="mt-4">${renderAdvancedFiltersSectionForMarketplace()}</div>` : ''}</div><div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-8">${paginatedProducts.length > 0 ? productCardsHtml : '<p class="col-span-full text-center text-gray-600">No products found.</p>'}</div>${renderPagination()}</div></div></div></div>`;}
        function renderAdvancedFiltersSectionForMarketplace() { const filteredCategories = allCategories.filter(c => c.toLowerCase().includes(appState.filters.categorySearchTerm.toLowerCase())); const filteredColors = allColorNames.filter(c => c.toLowerCase().includes(appState.filters.colorSearchTerm.toLowerCase())); const colorCheckboxesHtml = filteredColors.map(c => { const h = Object.keys(colorMap).find(k => colorMap[k] === c); return `<label for="color-${c}" class="filter-item-label"><input type="checkbox" id="color-${c}" name="color" value="${c}" ${appState.filters.selectedColors.includes(c) ? 'checked' : ''}><span class="color-circle" style="background-color: ${h};"></span><span class="ml-2 text-sm text-gray-700">${c}</span></label>`; }).join(''); const categoryCheckboxesHtml = filteredCategories.map(c => `<label for="category-${c}" class="filter-item-label"><input type="checkbox" id="category-${c}" name="category" value="${c}" ${appState.filters.selectedCategories.includes(c) ? 'checked' : ''}><span class="ml-2 text-sm text-gray-700">${c}</span></label>`).join(''); return `<div class="bg-white rounded-lg enhanced-shadow p-6 text-gray-700"><h3 class="text-xl font-bold mb-4">Filters</h3><div class="space-y-6"><div><label class="font-semibold">Category</label><div class="relative mt-2"><div id="category-dropdown-toggle" class="cursor-pointer p-2 border rounded-md flex justify-between items-center bg-white"><span class="text-gray-500">${appState.filters.selectedCategories.length > 0 ? `${appState.filters.selectedCategories.length} selected` : 'Select...'}</span><svg class="w-5 h-5 text-gray-400 ${appState.showCategoryDropdown ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg></div><div id="category-dropdown" class="absolute top-full left-0 mt-1 w-full bg-white border rounded-md z-10 ${appState.showCategoryDropdown ? '' : 'hidden'}"><input type="text" id="category-search-input" placeholder="Search..." value="${appState.filters.categorySearchTerm}" class="w-full p-2 border-b"><div class="dropdown-checkbox-list p-2">${categoryCheckboxesHtml}</div></div></div></div><div><label class="font-semibold">Color</label><div class="relative mt-2"><div id="color-dropdown-toggle" class="cursor-pointer p-2 border rounded-md flex justify-between items-center bg-white"><span class="text-gray-500">${appState.filters.selectedColors.length > 0 ? `${appState.filters.selectedColors.length} selected` : 'Select...'}</span><svg class="w-5 h-5 text-gray-400 ${appState.showColorDropdown ? 'rotate-180' : ''}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M19 9l-7 7-7-7"></path></svg></div><div id="color-dropdown" class="absolute top-full left-0 mt-1 w-full bg-white border rounded-md z-10 ${appState.showColorDropdown ? '' : 'hidden'}"><input type="text" id="color-search-input" placeholder="Search..." value="${appState.filters.colorSearchTerm}" class="w-full p-2 border-b"><div class="dropdown-checkbox-list p-2">${colorCheckboxesHtml}</div></div></div></div><div><label class="font-semibold mb-2 block">Price Range ($)</label><div class="flex items-center gap-2"><input type="number" id="min-price-marketplace" placeholder="min" value="${appState.filters.minPrice}" class="w-1/2 p-2 border rounded-md"><span class="text-gray-500">-</span><input type="number" id="max-price-marketplace" placeholder="max" value="${appState.filters.maxPrice}" class="w-1/2 p-2 border rounded-md"></div></div><div><label class="font-semibold">Min Rating</label><select id="min-rating-marketplace" class="w-full p-2 border rounded-md mt-2"><option value="">Any</option><option value="1" ${appState.filters.minRating === '1' ? 'selected' : ''}>1+</option><option value="2" ${appState.filters.minRating === '2' ? 'selected' : ''}>2+</option><option value="3" ${appState.filters.minRating === '3' ? 'selected' : ''}>3+</option><option value="4" ${appState.filters.minRating === '4' ? 'selected' : ''}>4+</option><option value="5" ${appState.filters.minRating === '5' ? 'selected' : ''}>5</option></select></div></div><div class="flex gap-2 mt-6"><button id="reset-marketplace-filters" class="w-full bg-gray-200 py-2 rounded-lg">Reset</button><button id="apply-marketplace-filters" class="w-full bg-emerald-600 text-white py-2 rounded-lg">Apply</button></div></div>`; }
        function getFilteredProducts() { return mockProducts.filter(p => { const s = appState.searchTerm.toLowerCase(); const matchesSearch = s === '' || p.title.toLowerCase().includes(s) || p.description.toLowerCase().includes(s) || p.provider.toLowerCase().includes(s); const minP = parseFloat(appState.filters.minPrice); const maxP = parseFloat(appState.filters.maxPrice); const matchesPrice = (isNaN(minP) || p.price >= minP) && (isNaN(maxP) || p.price <= maxP); const matchesRating = appState.filters.minRating === '' || p.rating >= parseFloat(appState.filters.minRating); const matchesCat = appState.filters.selectedCategories.length === 0 || appState.filters.selectedCategories.includes(p.category); const matchesColor = appState.filters.selectedColors.length === 0 || p.productImages.some(img => { const c = colorMap[img.color.toLowerCase()]; return appState.filters.selectedColors.includes(c); }); return matchesSearch && matchesPrice && matchesRating && matchesCat && matchesColor; });}
        function renderPagination() { const prods = getFilteredProducts(); const total = Math.ceil(prods.length / appState.productsPerPage); if (total <= 1) return ''; let html = `<nav class="flex justify-center items-center space-x-2 mt-8">`; html += `<button onclick="changePage(event, ${appState.currentPage - 1})" class="w-10 h-10 flex items-center justify-center rounded-lg border bg-white ${appState.currentPage === 1 ? 'pointer-events-none opacity-50' : ''}"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M15 19l-7-7 7-7"></path></svg></button>`; for (let i = 1; i <= total; i++) { html += `<button onclick="changePage(event, ${i})" class="w-10 h-10 rounded-lg font-semibold border ${appState.currentPage === i ? 'page-active' : 'bg-white'}">${i}</button>`; } html += `<button onclick="changePage(event, ${appState.currentPage + 1})" class="w-10 h-10 flex items-center justify-center rounded-lg border bg-white ${appState.currentPage === total ? 'pointer-events-none opacity-50' : ''}"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7"></path></svg></button>`; html += `</nav>`; return html; }
        
        // --- DETAIL VIEW RENDER ---
        function renderProductDetailPage() {
            const product = mockProducts.find(p => p.id === appState.selectedProductId);
            if (!product) return `<div class="text-center p-12">Product not found. <button onclick="goBackToGrid()" class="text-emerald-600 hover:underline">Go back</button></div>`;

            const colorSwatchesHtml = product.productImages.map((img, index) => `
                <div class="color-swatch ${index === 0 ? 'selected' : ''}" 
                     style="background-color: ${img.color};"
                     title="${colorMap[img.color.toLowerCase()]}"
                     onclick="handleColorSelection('${img.imageUrl}', this)">
                </div>
            `).join('');
            
            const sizeButtonsHtml = (product.sizes && product.sizes.length > 0) 
                ? product.sizes.map((size, index) => `
                    <button class="size-button ${index === 0 ? 'selected' : ''}" onclick="handleSizeSelection(this)">
                        ${size}
                    </button>
                `).join('')
                : '<p class="text-sm text-gray-500">One size</p>';

            const reviewsHtml = (product.customerReviews && product.customerReviews.length > 0) 
                ? product.customerReviews.map(review => `
                    <div class="border-t border-gray-200 pt-4">
                        <div class="flex items-center mb-1">
                            ${renderStars(review.rating, true)}
                            <p class="ml-3 font-bold text-gray-800">${review.name}</p>
                        </div>
                        <p class="text-gray-600">${review.comment}</p>
                    </div>
                `).join('')
                : `<p class="text-gray-500">No reviews yet. Be the first to write one!</p>`;

            return `
                <div class="container mx-auto px-4 py-8">
                    <button onclick="goBackToGrid()" class="mb-6 inline-flex items-center gap-2 text-gray-600 font-semibold hover:text-emerald-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        Back to all products
                    </button>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-7 gap-8">
                        <!-- Left Column: Image Gallery -->
                        <div class="lg:col-span-4">
                             <div class="bg-white rounded-lg p-4 border sticky top-24">
                                <img id="main-product-image" src="${product.productImages[0].imageUrl}" alt="${product.imageAlt}" class="w-full h-auto object-contain rounded-md aspect-[4/3]">
                            </div>
                        </div>

                        <!-- Right Column: Product Info -->
                        <div class="lg:col-span-3">
                            <h1 class="text-3xl font-bold text-gray-900">${product.title}</h1>
                            <a href="#" class="text-sm text-emerald-600 hover:underline mt-1 block">Visit the ${product.provider} Store</a>
                            
                            <div class="flex items-center my-4">
                                ${renderStars(product.rating, true)}
                                <a href="#reviews-section" class="ml-3 text-sm text-gray-600 hover:text-emerald-600">${product.reviews} ratings</a>
                            </div>

                            <hr class="my-4">
                            
                            <div>
                                <h3 class="text-md font-semibold text-gray-700 mb-2">Color: <span id="color-name-display">${colorMap[product.productImages[0].color.toLowerCase()]}</span></h3>
                                <div class="flex items-center space-x-2">
                                    ${colorSwatchesHtml}
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <h3 class="text-md font-semibold text-gray-700 mb-2">Select Size: <span id="size-display">${product.sizes ? product.sizes[0] : ''}</span></h3>
                                <div id="size-selector" class="flex items-center flex-wrap gap-2">
                                    ${sizeButtonsHtml}
                                </div>
                            </div>
                            
                            <hr class="my-6">

                            <div class="space-y-4">
                                <h3 class="text-xl font-bold text-gray-800">About this item</h3>
                                <ul class="list-disc list-inside text-gray-600 space-y-2">
                                    ${product.description.split('. ').filter(s => s).map(sentence => `<li>${sentence}</li>`).join('')}
                                </ul>
                            </div>
                            
                             <div class="mt-6 p-4 border-2 border-gray-200 rounded-lg">
                                <p class="text-3xl font-extrabold text-gray-900">$${product.price.toFixed(2)}</p>
                                <p class="mt-2 text-green-600 font-semibold">${product.offerStatus}</p>
                                <p class="text-sm text-gray-500 mt-2">Delivery to Cairo</p>
                                <button onclick="showAddToCartModal('${product.title}')" class="w-full mt-4 bg-emerald-600 text-white py-3 rounded-lg font-semibold text-lg hover:bg-emerald-700 focus:outline-none focus:ring-4 focus:ring-emerald-300 transition duration-200">
                                    Add to Cart
                                </button>
                                <button class="w-full mt-2 bg-emerald-700 text-white py-3 rounded-lg font-semibold text-lg hover:bg-emerald-800 focus:outline-none focus:ring-4 focus:ring-emerald-400 transition duration-200">
                                    Buy Now
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Full-width Reviews Section -->
                    <div id="reviews-section" class="bg-white rounded-lg enhanced-shadow p-6 mt-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Customer Reviews</h2>
                        <div class="space-y-6 mb-8">${reviewsHtml}</div>
                        <div class="border-t border-gray-200 pt-6">
                             <h3 class="text-xl font-semibold text-gray-800">Write a review</h3>
                             <div class="mt-4"><p class="text-gray-600 mb-2">Your Rating</p><div id="new-review-stars" class="star-rating-input text-3xl text-gray-300"><i class="fas fa-star" data-value="1"></i><i class="fas fa-star" data-value="2"></i><i class="fas fa-star" data-value="3"></i><i class="fas fa-star" data-value="4"></i><i class="fas fa-star" data-value="5"></i></div></div>
                             <div class="mt-4"><label for="review-comment" class="block text-gray-600 mb-2">Your Review</label><textarea id="review-comment" rows="4" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-emerald-500" placeholder="Share your thoughts on the product..."></textarea></div>
                             <button id="submit-review-btn" class="mt-4 bg-emerald-600 text-white font-semibold px-6 py-2 rounded-lg hover:bg-emerald-700 transition">Submit Review</button>
                        </div>
                    </div>
                </div>
            `;
        }

        // --- EVENT HANDLERS ---
        function handleGridColorClick(event, productId) {
            event.stopPropagation(); // Prevent card click event when clicking on a color
            const clickedColorDiv = event.currentTarget;
            const newImageUrl = clickedColorDiv.dataset.imageUrl;
            
            const productCard = document.getElementById(`product-card-${productId}`);
            const productImage = document.getElementById(`product-image-${productId}`);
            const colorChoices = productCard.querySelectorAll(`[data-product-id="${productId}"][data-color]`);

            if (productImage) {
                productImage.src = newImageUrl;
            }

            colorChoices.forEach(div => {
                div.classList.remove('border-emerald-500', 'ring-2', 'ring-emerald-200');
                div.classList.add('border-gray-300');
            });
            clickedColorDiv.classList.add('border-emerald-500', 'ring-2', 'ring-emerald-200');
            clickedColorDiv.classList.remove('border-gray-300');
        }

        function handleColorSelection(newImageUrl, selectedSwatchElement) {
            document.getElementById('main-product-image').src = newImageUrl;
            document.querySelectorAll('.color-swatch').forEach(swatch => swatch.classList.remove('selected'));
            selectedSwatchElement.classList.add('selected');
            const rgbColor = selectedSwatchElement.style.backgroundColor;
            const hexColor = rgbToHex(rgbColor);
            const colorName = colorMap[hexColor.toLowerCase()] || 'Unknown';
            document.getElementById('color-name-display').innerText = colorName;
        }

        function handleSizeSelection(selectedButtonElement) {
            document.querySelectorAll('#size-selector .size-button').forEach(button => button.classList.remove('selected'));
            selectedButtonElement.classList.add('selected');
            document.getElementById('size-display').innerText = selectedButtonElement.innerText;
        }

        function showAddToCartModal(productTitle) { appState.modalContent = { title: 'Item Added to Cart!', message: `${productTitle} has been added.` }; renderPage(); }
        function applyMarketplaceFilters() { appState.filters.minPrice = document.getElementById('min-price-marketplace')?.value; appState.filters.maxPrice = document.getElementById('max-price-marketplace')?.value; appState.filters.minRating = document.getElementById('min-rating-marketplace')?.value; if (window.innerWidth < 1024) appState.showAdvancedFilters = false; appState.currentPage = 1; renderPage(); }
        function resetMarketplaceFilters() { appState.searchTerm = ''; appState.filters = { minPrice: '', maxPrice: '', minRating: '', selectedCategories: [], categorySearchTerm: '', selectedColors: [], colorSearchTerm: '' }; appState.currentPage = 1; if (window.innerWidth < 1024) appState.showAdvancedFilters = false; renderPage(); }
        function changePage(event, page) { const prods = getFilteredProducts(); const total = Math.ceil(prods.length / appState.productsPerPage); if (page >= 1 && page <= total) { appState.currentPage = page; renderPage(); } }
        function handleCategoryCheckboxChange(e) { const cat = e.target.value; const i = appState.filters.selectedCategories.indexOf(cat); if (e.target.checked) { if (i === -1) appState.filters.selectedCategories.push(cat); } else { if (i > -1) appState.filters.selectedCategories.splice(i, 1); } appState.currentPage = 1; renderPage(); }
        function handleCategorySearchInput(e) { appState.filters.categorySearchTerm = e.target.value; renderPage(); }
        function handleColorCheckboxChange(e) { const c = e.target.value; const i = appState.filters.selectedColors.indexOf(c); if (e.target.checked) { if (i === -1) appState.filters.selectedColors.push(c); } else { if (i > -1) appState.filters.selectedColors.splice(i, 1); } appState.currentPage = 1; renderPage(); }
        function handleColorSearchInput(e) { appState.filters.colorSearchTerm = e.target.value; renderPage(); }
        function toggleCategoryDropdown() { appState.showCategoryDropdown = !appState.showCategoryDropdown; renderPage(); }
        function toggleColorDropdown() { appState.showColorDropdown = !appState.showColorDropdown; renderPage(); }
        
        function attachEventListeners() { 
            // Mobile Menu Toggle
            document.getElementById('mobile-menu-button')?.addEventListener('click', () => {
                appState.isMobileMenuOpen = !appState.isMobileMenuOpen;
                renderPage();
            });

            document.getElementById('profile-button')?.addEventListener('click', (e) => { e.stopPropagation(); appState.isProfileDropdownOpen = !appState.isProfileDropdownOpen; renderPage(); }); 
            document.body.addEventListener('click', (e) => { let c = false; if (appState.isProfileDropdownOpen && !e.target.closest('#profile-dropdown') && !e.target.closest('#profile-button')) { appState.isProfileDropdownOpen = false; c = true; } if (appState.showCategoryDropdown && !e.target.closest('#category-dropdown') && !e.target.closest('#category-dropdown-toggle')) { appState.showCategoryDropdown = false; c = true; } if (appState.showColorDropdown && !e.target.closest('#color-dropdown') && !e.target.closest('#color-dropdown-toggle')) { appState.showColorDropdown = false; c = true; } if (c) renderPage(); }); 
            
            if (appState.view === 'grid') { 
                document.getElementById('search-button-marketplace')?.addEventListener('click', () => { appState.currentPage = 1; renderPage(); }); 
                const si = document.getElementById('search-term-marketplace'); if (si) { si.addEventListener('input', (e) => { appState.searchTerm = e.target.value; }); si.addEventListener('keydown', (e) => { if (e.key === 'Enter') { appState.currentPage = 1; renderPage(); }}); } 
                document.getElementById('toggle-advanced-filters-marketplace')?.addEventListener('click', () => { appState.showAdvancedFilters = !appState.showAdvancedFilters; renderPage(); }); 
                document.getElementById('apply-marketplace-filters')?.addEventListener('click', applyMarketplaceFilters); 
                document.getElementById('reset-marketplace-filters')?.addEventListener('click', resetMarketplaceFilters); 
                document.getElementById('category-dropdown-toggle')?.addEventListener('click', (e) => { e.stopPropagation(); toggleCategoryDropdown(); }); 
                document.getElementById('category-search-input')?.addEventListener('input', handleCategorySearchInput); 
                document.getElementById('category-options-container')?.addEventListener('change', handleCategoryCheckboxChange); 
                document.getElementById('color-dropdown-toggle')?.addEventListener('click', (e) => { e.stopPropagation(); toggleColorDropdown(); }); 
                document.getElementById('color-search-input')?.addEventListener('input', handleColorSearchInput); 
                document.getElementById('color-options-container')?.addEventListener('change', handleColorCheckboxChange); 
            } 
            
            if (appState.view === 'detail') { 
                const sc = document.getElementById('new-review-stars'); 
                if (sc) { 
                    const stars = sc.querySelectorAll('.fa-star'); 
                    stars.forEach(star => { 
                        star.addEventListener('mouseover', () => { stars.forEach(s => s.classList.remove('hover')); for (let i = 0; i < star.dataset.value; i++) { stars[i].classList.add('hover'); } }); 
                        sc.addEventListener('mouseleave', () => { stars.forEach(s => s.classList.remove('hover')); }); 
                        star.addEventListener('click', () => { appState.newReviewRating = star.dataset.value; stars.forEach(s => { s.classList.toggle('filled', s.dataset.value <= appState.newReviewRating); }); }); 
                    }); 
                } 
                document.getElementById('submit-review-btn')?.addEventListener('click', () => { 
                    const c = document.getElementById('review-comment').value; 
                    if (appState.newReviewRating > 0 && c.trim() !== '') { 
                        appState.modalContent = { title: 'Review Submitted!', message: 'Thank you for your feedback.' }; 
                        appState.newReviewRating = 0; 
                        renderPage(); 
                    } else { 
                        alert('Please provide a rating and a comment.'); 
                    } 
                }); 
            } 
        }

        // --- MAIN APPLICATION LOGIC ---
        function renderPage() {
             const appDiv = document.getElementById('app');
            let contentHtml = '';

            if (appState.view === 'grid') {
                contentHtml = renderMarketplaceGrid();
            } else if (appState.view === 'detail') {
                contentHtml = renderProductDetailPage();
            }

            appDiv.innerHTML = `
                ${renderHeader()}
                ${contentHtml}
                ${renderFooter()}
                ${appState.modalContent ? renderModal(appState.modalContent.title, appState.modalContent.message) : ''}
            `;
            attachEventListeners();
        }

        // Initial render
        document.addEventListener('DOMContentLoaded', renderPage);
    </script>
</body>
</html>
